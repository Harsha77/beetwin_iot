import{r as p,c as _,w as R,j as z,C as m,D as u,G as e,K as B,N as d,W as E,Z as V,F as O,V as Z,P as J,M as F,u as Q}from"./@vue-6KHaxNJ6.js";import{_ as I}from"./Download-Chzou-sw.js";import{b as X}from"./vue-router-CPl752RW.js";import{a as Y}from"./axios-C_yEy3-Q.js";import{u as C,w as tt}from"./xlsx-DAQG1NUx.js";import{L as D}from"./leaflet-CDkOlCyp.js";import{E as et}from"./vue-echarts-DSvovFkh.js";import{h as ot}from"./html2canvas-CIV5arX1.js";import{a as rt}from"./frappe-ui-CIwioayB.js";import{u as at,a as st,b as lt,c as nt,d as it,e as dt}from"./echarts-CbA4AjIf.js";import"./feather-icons-09G7fcws.js";import"./socket.io-client-o9UT993-.js";import"./engine.io-client-DoYcFuH8.js";import"./engine.io-parser-QVnBb3PJ.js";import"./@socket.io-Dkula2eQ.js";import"./socket.io-parser-4mvwibnP.js";import"./@tiptap-BhO_3mwo.js";import"./prosemirror-dropcursor-DdDve3OF.js";import"./prosemirror-state-C0OblyT9.js";import"./prosemirror-model-CDAhqB4x.js";import"./orderedmap-C4TimWWB.js";import"./prosemirror-transform-DiPrUp-3.js";import"./prosemirror-gapcursor-B9ns80ZN.js";import"./prosemirror-keymap-BJ3QP8hu.js";import"./w3c-keyname-SJlxdkTY.js";import"./prosemirror-view-Dw0L6lI7.js";import"./prosemirror-history-4Kh61WTt.js";import"./rope-sequence-Cxv9J64N.js";import"./prosemirror-tables-Cnk26J7e.js";import"./linkifyjs-85EWwGDS.js";import"./prosemirror-commands-CZrlb0Rg.js";import"./prosemirror-schema-list-CPI4UhYk.js";import"./showdown-4mCZrU_9.js";import"./dayjs-CfxXAJTb.js";import"./idb-keyval-BeXAubRj.js";import"./@vueuse-moBmYcJ4.js";import"./reka-ui-jlgPPgUe.js";import"./@floating-ui-CoOhG2Tb.js";import"./vue-puX4Qeud.js";import"./tippy.js-BfW9tSbp.js";import"./@popperjs-DEdMZ52H.js";import"./@headlessui-C4-e1rF0.js";import"./lowlight-CuXNySGc.js";import"./highlight.js-kvRu1DFi.js";import"./tslib-BDyQ-Jie.js";import"./zrender-B8kCopLz.js";const pt="/assets/beetwin_iot/iotweet-dashboard/BackButton.png",mt={class:"min-h-screen p-6"},ut={class:"flex justify-between items-center mb-4"},ct={class:"text-xl font-bold text-center w-full"},gt={class:"flex flex-col md:flex-row items-center justify-center gap-4 mb-4"},bt={class:"flex items-center gap-2"},ht={class:"flex items-center gap-2"},vt={key:0,class:"flex justify-center items-center h-64"},ft={key:1,class:"overflow-x-auto"},yt={class:"max-h-[400px] overflow-y-auto border border-gray-300 rounded"},wt={class:"sticky-header w-full border"},xt={class:"border border-gray-300 px-4 py-2"},_t={class:"border border-gray-300 px-4 py-2"},Dt={class:"border border-gray-300 px-4 py-2"},kt={class:"border border-gray-300 px-4 py-2"},St={class:"border border-gray-300 px-4 py-2"},Nt={key:2,class:"text-center text-gray-500"},$t={class:"graph-container mt-6 p-4 border border-gray-300 rounded bg-white w-full overflow-x-auto"},Lt={class:"flex items-center justify-between"},Pt={class:"text-lg font-bold text-center w-full"},Mt={class:"text-gray-600"},At={class:"relative w-full border border-gray-300 rounded-lg shadow-md bg-white p-4"},Bt={class:"text-lg font-bold text-center mb-2"},Ct={class:"text-gray-600"},Tt={__name:"DeviceDetails",setup(jt){at([st,lt,nt,it,dt]);const b=X(),h=p(b.params.deviceId),a=p([]);p(1);const G=p(10),c=p(!0);let n=null,k=[];const S=_(()=>{const r=a.value.filter(t=>t.lat&&t.long);return r.length>0?r.reduce((t,o)=>new Date(o.timestamp)>new Date(t.timestamp)?o:t):null}),q=async()=>{const r=document.querySelector(".graph-container");if(!r){alert("Graph container not found!");return}try{const o=(await ot(r,{scale:2})).toDataURL("image/jpeg"),l=document.createElement("a");l.href=o,l.download=`Pressure_Graph_${b.query.serialNumber||"N/A"}.jpg`,document.body.appendChild(l),l.click(),document.body.removeChild(l)}catch(t){console.error("Error downloading graph:",t)}},U=()=>{if(a.value.length===0){alert("No data available to download.");return}const r=b.query.serialNumber||"N/A",t=[[`Time Series Table For (Sr.No: ${r} |ID: ${h.value})`]],o=[["Timestamp","Pressure (bar)","Battery (%)","Sensor Health","Latitude","Longitude","Signal Strength"]],l=a.value.map(i=>[i.timestamp.slice(0,16),i.pv,i.bt,i.ht,i.lat,i.long,i.rssi]),P=[...t,[],...o,...l],M=C.aoa_to_sheet(P),w=C.book_new();C.book_append_sheet(w,M,"Device Report"),tt(w,`Telemetry_Report_${r}.xlsx`)},v=p(""),f=p(""),N=async()=>{c.value=!0;let r={device_data:h.value};v.value&&f.value&&(r.from_date=v.value,r.to_date=f.value);try{const t=await Y.post("/api/method/beetwin_iot.beetwin_iot.report.btx_pp_timeseries_data_table.btx_pp_timeseries_data_table.generate_device_report",r,{headers:{"Content-Type":"application/json"}});console.log("API Response Data:",t.data.message.data),t.data.message&&t.data.message.data?a.value=[...t.data.message.data]:a.value=[]}catch(t){console.error("Error fetching report data:",t),a.value=[]}finally{c.value=!1,console.log("Loading Finished. Report Data Size:",a.value.length)}},H=async()=>{await N()},$=_(()=>{const r=[...a.value].sort((t,o)=>new Date(t.timestamp)-new Date(o.timestamp));return{tooltip:{trigger:"axis"},grid:{left:"10%",right:"5%",bottom:"20%",containLabel:!0},xAxis:{type:"category",data:r.map(t=>{const o=new Date(t.timestamp);return`${String(o.getDate()).padStart(2,"0")}/${String(o.getMonth()+1).padStart(2,"0")}
${String(o.getHours()).padStart(2,"0")}:${String(o.getMinutes()).padStart(2,"0")}`}),axisLabel:{fontSize:window.innerWidth<768?10:12,rotate:30,interval:"auto"}},yAxis:{type:"value",name:"Pressure (bar)",min:function(t){return Math.floor(t.min*.9)},max:function(t){return Math.ceil(t.max*1.1)},axisLabel:{formatter:"{value} bar",fontSize:window.innerWidth<768?10:12}},series:[{name:"Pressure",type:"line",data:r.map(t=>t.pv),smooth:.2,lineStyle:{width:2,color:"#FFA500"},symbolSize:window.innerWidth<768?4:6}]}}),y=_(()=>a.value);_(()=>Math.ceil(a.value.length/G.value));const L=()=>{n=D.map("device-map",{center:[22.3511,78.6677],zoom:5,maxBounds:[[6.5,68],[35,97.5]],maxBoundsViscosity:1}),D.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(n),g()},g=()=>{var T,j;if(!n){console.warn("Map is not initialized yet.");return}console.log("Updating Map..."),k.forEach(s=>n.removeLayer(s)),k=[];let r=a.value.filter(s=>s.lat&&s.long).sort((s,A)=>new Date(A.timestamp)-new Date(s.timestamp))[0],t=a.value.filter(s=>s.pv!==null&&s.pv!==void 0&&s.bt!==null&&s.bt!==void 0).sort((s,A)=>new Date(A.timestamp)-new Date(s.timestamp))[0];if(!r||!t){console.warn("No valid latitude/longitude or PV/BT found.");return}let o=Number(r.lat),l=Number(r.long),P=(T=t.pv)!=null?T:"N/A",M=(j=t.bt)!=null?j:"N/A",w=new Date(r.timestamp).toLocaleString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).replace(",","");const i=D.icon({iconUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",shadowSize:[41,41]});let x=D.marker([o,l],{icon:i}).addTo(n);k.push(x);let K=`
    <strong>Device ID:</strong> ${h.value} <br>
    <strong>Serial Number:</strong> ${b.query.serialNumber||"N/A"} <br>
    <strong>Pressure:</strong> ${P} bar<br>
    <strong>Battery:</strong> ${M}% <br>
    <strong>Timestamp:</strong> ${w}
  `;x.bindPopup(K),x.on("mouseover",function(){this.openPopup()}),x.on("mouseout",function(){this.closePopup()}),console.log("Latest Marker Plotted at:",o,l),n.setView([o,l],12)};R(y,g,{deep:!0});const W=()=>{n&&(n.remove(),n=null),L()};return R(a,()=>{W(),g(),$.value={...$.value}},{deep:!0}),z(async()=>{await N(),L(),g()}),z(async()=>{await N(),L(),g()}),(r,t)=>(u(),m("div",mt,[e("div",ut,[e("button",{onClick:t[0]||(t[0]=o=>r.$router.push("/")),class:"ml-4"},t[3]||(t[3]=[e("img",{src:pt,alt:"Download",class:"w-10 h-10"},null,-1)])),e("h2",ct," Sr.No: "+d(r.$route.query.serialNumber||"N/A")+" | ID: "+d(h.value),1),e("button",{onClick:U,class:"ml-4"},t[4]||(t[4]=[e("img",{src:I,alt:"Download",class:"w-10 h-10"},null,-1)]))]),e("div",gt,[e("div",bt,[t[5]||(t[5]=e("label",{class:"font-semibold"},"From Date:",-1)),E(e("input",{type:"date","onUpdate:modelValue":t[1]||(t[1]=o=>v.value=o),class:"border rounded px-2 py-1"},null,512),[[V,v.value]])]),e("div",ht,[t[6]||(t[6]=e("label",{class:"font-semibold"},"To Date:",-1)),E(e("input",{type:"date","onUpdate:modelValue":t[2]||(t[2]=o=>f.value=o),class:"border rounded px-2 py-1"},null,512),[[V,f.value]])]),e("button",{onClick:H,class:"bg-[#08444c] text-white px-4 py-2 rounded"},"Generete Report")]),c.value?(u(),m("div",vt,t[7]||(t[7]=[e("svg",{class:"animate-spin h-10 w-10 text-blue-500",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"4"},[e("circle",{cx:"12",cy:"12",r:"10","stroke-opacity":"0.2"}),e("path",{d:"M22 12a10 10 0 1 1-10-10","stroke-linecap":"round"})],-1)]))):B("",!0),!c.value&&y.value.length>0?(u(),m("div",ft,[e("div",yt,[e("table",wt,[t[8]||(t[8]=e("thead",{class:"bg-gray-200"},[e("tr",null,[e("th",{class:"border border-gray-300 px-4 py-2"},"Timestamp"),e("th",{class:"border border-gray-300 px-4 py-2"},"Pressure (bar)"),e("th",{class:"border border-gray-300 px-4 py-2"},"Battery (%)"),e("th",{class:"border border-gray-300 px-4 py-2"},"Sensor Health"),e("th",{class:"border border-gray-300 px-4 py-2"},"Signal Strength")])],-1)),e("tbody",null,[(u(!0),m(O,null,Z(y.value,o=>(u(),m("tr",{key:o.timestamp,class:"text-center"},[e("td",xt,d(o.timestamp.slice(0,16)),1),e("td",_t,d(o.pv),1),e("td",Dt,d(o.bt),1),e("td",kt,d(o.ht),1),e("td",St,d(o.rssi),1)]))),128))])])])])):B("",!0),!c.value&&y.value.length===0?(u(),m("p",Nt," No data available for this device. ")):B("",!0),e("div",$t,[e("div",Lt,[e("h3",Pt,[t[9]||(t[9]=F(" Pressure Graph - ")),e("span",Mt,d(r.$route.query.serialNumber||"N/A"),1)]),e("button",{onClick:q,class:"ml-auto w-8 h-8 md:w-10 md:h-10"},t[10]||(t[10]=[e("img",{src:I,alt:"Download",class:"w-full h-full"},null,-1)]))]),J(Q(et),{id:"pressureChart",class:"w-full h-80",option:$.value},null,8,["option"])]),t[13]||(t[13]=e("div",{class:"h-6"},null,-1)),e("div",At,[e("h3",Bt,[t[11]||(t[11]=F(" Latitude & Longitude - ")),e("span",Ct,d(S.value?S.value.lat+", "+S.value.long:"N/A"),1)]),t[12]||(t[12]=e("div",{id:"device-map",class:"border border-gray-300 rounded-md",style:{height:"400px"}},null,-1))])]))}},Le=rt(Tt,[["__scopeId","data-v-770fda5e"]]);export{Le as default};
