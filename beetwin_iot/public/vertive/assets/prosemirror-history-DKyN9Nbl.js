import{r as y}from"./rope-sequence-DGojYqW9.js";import{M as k}from"./prosemirror-transform-DoYUQK9o.js";import{a as O,P as H}from"./prosemirror-state-DgsmxDjm.js";const R=500;class c{constructor(t,e){this.items=t,this.eventCount=e}popEvent(t,e){if(this.eventCount==0)return null;let s=this.items.length;for(;;s--)if(this.items.get(s-1).selection){--s;break}let i,p;e&&(i=this.remapping(s,this.items.length),p=i.maps.length);let l=t.tr,r,a,m=[],f=[];return this.items.forEach((o,u)=>{if(!o.step){i||(i=this.remapping(s,u+1),p=i.maps.length),p--,f.push(o);return}if(i){f.push(new h(o.map));let d=o.step.map(i.slice(p)),w;d&&l.maybeStep(d).doc&&(w=l.mapping.maps[l.mapping.maps.length-1],m.push(new h(w,void 0,void 0,m.length+f.length))),p--,w&&i.appendMap(w,p)}else l.maybeStep(o.step);if(o.selection)return r=i?o.selection.map(i.slice(p)):o.selection,a=new c(this.items.slice(0,s).append(f.reverse().concat(m)),this.eventCount-1),!1},this.items.length,0),{remaining:a,transform:l,selection:r}}addTransform(t,e,s,i){let p=[],l=this.eventCount,r=this.items,a=!i&&r.length?r.get(r.length-1):null;for(let f=0;f<t.steps.length;f++){let o=t.steps[f].invert(t.docs[f]),u=new h(t.mapping.maps[f],o,e),d;(d=a&&a.merge(u))&&(u=d,f?p.pop():r=r.slice(0,r.length-1)),p.push(u),e&&(l++,e=void 0),i||(a=u)}let m=l-s.depth;return m>x&&(r=D(r,m),l-=m),new c(r.append(p),l)}remapping(t,e){let s=new k;return this.items.forEach((i,p)=>{let l=i.mirrorOffset!=null&&p-i.mirrorOffset>=t?s.maps.length-i.mirrorOffset:void 0;s.appendMap(i.map,l)},t,e),s}addMaps(t){return this.eventCount==0?this:new c(this.items.append(t.map(e=>new h(e))),this.eventCount)}rebased(t,e){if(!this.eventCount)return this;let s=[],i=Math.max(0,this.items.length-e),p=t.mapping,l=t.steps.length,r=this.eventCount;this.items.forEach(u=>{u.selection&&r--},i);let a=e;this.items.forEach(u=>{let d=p.getMirror(--a);if(d==null)return;l=Math.min(l,d);let w=p.maps[d];if(u.step){let b=t.steps[d].invert(t.docs[d]),C=u.selection&&u.selection.map(p.slice(a+1,d));C&&r++,s.push(new h(w,b,C))}else s.push(new h(w))},i);let m=[];for(let u=e;u<l;u++)m.push(new h(p.maps[u]));let f=this.items.slice(0,i).append(m).append(s),o=new c(f,r);return o.emptyItemCount()>R&&(o=o.compress(this.items.length-s.length)),o}emptyItemCount(){let t=0;return this.items.forEach(e=>{e.step||t++}),t}compress(t=this.items.length){let e=this.remapping(0,t),s=e.maps.length,i=[],p=0;return this.items.forEach((l,r)=>{if(r>=t)i.push(l),l.selection&&p++;else if(l.step){let a=l.step.map(e.slice(s)),m=a&&a.getMap();if(s--,m&&e.appendMap(m,s),a){let f=l.selection&&l.selection.map(e.slice(s));f&&p++;let o=new h(m.invert(),a,f),u,d=i.length-1;(u=i.length&&i[d].merge(o))?i[d]=u:i.push(o)}}else l.map&&s--},this.items.length,0),new c(y.from(i.reverse()),p)}}c.empty=new c(y.empty,0);function D(n,t){let e;return n.forEach((s,i)=>{if(s.selection&&t--==0)return e=i,!1}),n.slice(e)}class h{constructor(t,e,s,i){this.map=t,this.step=e,this.selection=s,this.mirrorOffset=i}merge(t){if(this.step&&t.step&&!t.selection){let e=t.step.merge(this.step);if(e)return new h(e.getMap().invert(),e,this.selection)}}}class g{constructor(t,e,s,i){this.done=t,this.undone=e,this.prevRanges=s,this.prevTime=i}}const x=20;function F(n,t,e,s){let i=e.getMeta(v),p;if(i)return i.historyState;e.getMeta(K)&&(n=new g(n.done,n.undone,null,0));let l=e.getMeta("appendedTransaction");if(e.steps.length==0)return n;if(l&&l.getMeta(v))return l.getMeta(v).redo?new g(n.done.addTransform(e,void 0,s,M(t)),n.undone,I(e.mapping.maps[e.steps.length-1]),n.prevTime):new g(n.done,n.undone.addTransform(e,void 0,s,M(t)),null,n.prevTime);if(e.getMeta("addToHistory")!==!1&&!(l&&l.getMeta("addToHistory")===!1)){let r=n.prevTime==0||!l&&(n.prevTime<(e.time||0)-s.newGroupDelay||!G(e,n.prevRanges)),a=l?T(n.prevRanges,e.mapping):I(e.mapping.maps[e.steps.length-1]);return new g(n.done.addTransform(e,r?t.selection.getBookmark():void 0,s,M(t)),c.empty,a,e.time)}else return(p=e.getMeta("rebased"))?new g(n.done.rebased(e,p),n.undone.rebased(e,p),T(n.prevRanges,e.mapping),n.prevTime):new g(n.done.addMaps(e.mapping.maps),n.undone.addMaps(e.mapping.maps),T(n.prevRanges,e.mapping),n.prevTime)}function G(n,t){if(!t)return!1;if(!n.docChanged)return!0;let e=!1;return n.mapping.maps[0].forEach((s,i)=>{for(let p=0;p<t.length;p+=2)s<=t[p+1]&&i>=t[p]&&(e=!0)}),e}function I(n){let t=[];return n.forEach((e,s,i,p)=>t.push(i,p)),t}function T(n,t){if(!n)return null;let e=[];for(let s=0;s<n.length;s+=2){let i=t.map(n[s],1),p=t.map(n[s+1],-1);i<=p&&e.push(i,p)}return e}function S(n,t,e,s){let i=M(t),p=v.get(t).spec.config,l=(s?n.undone:n.done).popEvent(t,i);if(!l)return;let r=l.selection.resolve(l.transform.doc),a=(s?n.done:n.undone).addTransform(l.transform,t.selection.getBookmark(),p,i),m=new g(s?a:l.remaining,s?l.remaining:a,null,0);e(l.transform.setSelection(r).setMeta(v,{redo:s,historyState:m}).scrollIntoView())}let E=!1,P=null;function M(n){let t=n.plugins;if(P!=t){E=!1,P=t;for(let e=0;e<t.length;e++)if(t[e].spec.historyPreserveItems){E=!0;break}}return E}const v=new O("history"),K=new O("closeHistory");function L(n={}){return n={depth:n.depth||100,newGroupDelay:n.newGroupDelay||500},new H({key:v,state:{init(){return new g(c.empty,c.empty,null,0)},apply(t,e,s){return F(e,s,t,n)}},config:n,props:{handleDOMEvents:{beforeinput(t,e){let s=e.inputType,i=s=="historyUndo"?j:s=="historyRedo"?A:null;return i?(e.preventDefault(),i(t.state,t.dispatch)):!1}}}})}const j=(n,t)=>{let e=v.getState(n);return!e||e.done.eventCount==0?!1:(t&&S(e,n,t,!1),!0)},A=(n,t)=>{let e=v.getState(n);return!e||e.undone.eventCount==0?!1:(t&&S(e,n,t,!0),!0)};export{L as h,A as r,j as u};
