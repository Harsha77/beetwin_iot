import{l as p,b as D,z as M,w as E,c as h,a as o,t as u,I as V,J as U,f as L,F as K,k as Q,g as Y,j as Z,C as ee,o as f}from"./@vue-D0TGCZL2.js";import{_ as z}from"./Download-D1HoHf0Z.js";import{b as te}from"./vue-router-DxnAzFk_.js";import{a as S}from"./axios-ByivMYyX.js";import{u as F,w as oe}from"./xlsx-DaVhO591.js";import{L as N}from"./leaflet-BUr-PN-6.js";import{E as re}from"./vue-echarts-DMS_o-FG.js";import{h as ae}from"./html2canvas-CIV5arX1.js";import{b as se}from"./frappe-ui-SSzMBOOI.js";import{u as ne,a as le,b as ie,c as ce,d as de,e as pe}from"./echarts-CGNzQbEM.js";import"./@tiptap-BUCYMH7K.js";import"./prosemirror-state-DgsmxDjm.js";import"./prosemirror-model-C_7RDaDb.js";import"./prosemirror-transform-DoYUQK9o.js";import"./prosemirror-dropcursor-BfstMEHz.js";import"./prosemirror-gapcursor-DAo5-j_C.js";import"./prosemirror-keymap-CVi9LBYH.js";import"./w3c-keyname-_MXnRwJa.js";import"./prosemirror-view-W--SXXbD.js";import"./prosemirror-history-DKyN9Nbl.js";import"./rope-sequence-DGojYqW9.js";import"./prosemirror-tables-DrV9oBPp.js";import"./linkifyjs-Bb8FdQht.js";import"./prosemirror-commands-Lnq4s3Q2.js";import"./prosemirror-schema-list-B9x1aVA0.js";import"./showdown-Dkx33vR8.js";import"./socket.io-client-De6w114h.js";import"./engine.io-client-CveMJrUI.js";import"./engine.io-parser-6vJSFETq.js";import"./@socket.io-Dkula2eQ.js";import"./socket.io-parser-D89bkXp7.js";import"./idb-keyval-BrH4ksw2.js";import"./tslib-BDyQ-Jie.js";import"./zrender-c6l8Dm-q.js";const ue="/assets/beetwin_iot/beetwin_hs/BackButton.png",me={class:"min-h-screen p-6"},ge={class:"flex justify-between items-center mb-4"},he={class:"text-xl font-bold text-center w-full"},fe={class:"flex flex-col md:flex-row items-center justify-center gap-4 mb-4"},be={class:"flex items-center gap-2"},ve={class:"flex items-center gap-2"},ye={key:0,class:"flex justify-center items-center h-64"},we={key:1,class:"overflow-x-auto"},_e={class:"max-h-[400px] overflow-y-auto border border-gray-300 rounded"},xe={class:"sticky-header w-full border"},ke={class:"border border-gray-300 px-4 py-2"},De={class:"border border-gray-300 px-4 py-2"},Se={class:"border border-gray-300 px-4 py-2"},Ne={class:"border border-gray-300 px-4 py-2"},Ce={class:"border border-gray-300 px-4 py-2"},Te={key:2,class:"text-center text-gray-500"},$e={class:"graph-container mt-6 p-4 border border-gray-300 rounded bg-white w-full overflow-x-auto"},Le={class:"flex items-center justify-between"},Fe={class:"text-lg font-bold text-center w-full"},Pe={class:"text-gray-600"},Ae={__name:"DeviceDetails",setup(Re){ne([le,ie,ce,de,pe]);const b=te(),v=p(b.params.deviceId),n=p([]);p(1);const I=p(10),m=p(!0);let i=null,C=[];D(()=>{const r=n.value.filter(e=>e.lat&&e.long);return r.length>0?r.reduce((e,t)=>new Date(t.timestamp)>new Date(e.timestamp)?t:e):null});const G=async()=>{const r=document.querySelector(".graph-container");if(!r){alert("Graph container not found!");return}try{const t=(await ae(r,{scale:2})).toDataURL("image/jpeg"),s=document.createElement("a");s.href=t,s.download=`Pressure_Graph_${b.query.serialNumber||"N/A"}.jpg`,document.body.appendChild(s),s.click(),document.body.removeChild(s)}catch(e){console.error("Error downloading graph:",e)}},q=()=>{if(n.value.length===0){alert("No data available to download.");return}const r=b.query.serialNumber||"N/A",e=[[`Time Series Table For (Sr.No: ${r} |ID: ${v.value})`]],t=[["Timestamp","Pressure (bar)","Battery (%)","Sensor Health","Latitude","Longitude","Signal Strength"]],s=n.value.map(c=>[c.timestamp.slice(0,16),c.pv,c.bt,c.ht,c.lat,c.long,c.rssi]),a=[...e,[],...t,...s],d=F.aoa_to_sheet(a),g=F.book_new();F.book_append_sheet(g,d,"Device Report"),oe(g,`Telemetry_Report_${r}.xlsx`)},y=p(""),w=p(""),H=async()=>{var r;try{if(window.csrf_token)return console.log("Using CSRF Token from window:",window.csrf_token),window.csrf_token;const t=(await S.get("/api/method/frappe.auth.get_logged_user",{withCredentials:!0})).headers["x-frappe-csrf-token"]||((r=document.cookie.match(/csrftoken=([^;]+)/))==null?void 0:r[1]);return console.log("Fetched CSRF Token:",t),t}catch(e){return console.error("Failed to fetch CSRF Token:",e),null}},P=async()=>{m.value=!0;const r=await H();if(!r){console.error("CSRF Token is missing. Aborting request."),m.value=!1;return}let e={device_data:v.value};y.value&&w.value&&(e.from_date=y.value,e.to_date=w.value);try{const t=await S.post("/api/method/beetwin_iot.beetwin_iot.report.btx_pp_timeseries_data_table.btx_pp_timeseries_data_table.generate_device_report",e,{headers:{"Content-Type":"application/json","X-Frappe-CSRF-Token":r,Accept:"application/json"},withCredentials:!0});console.log("API Response Data:",t.data.message.data),n.value=t.data.message.data||[]}catch(t){console.error("Error fetching report data:",t),n.value=[]}finally{m.value=!1}};M(async()=>{try{const r=await S.get("/api/method/frappe.auth.get_logged_user",{withCredentials:!0});console.log("Logged-in User:",r.data.message),r.data.message==="Guest"&&console.error("User is not logged in. Please log in first.")}catch(r){console.error("Error checking logged-in user:",r)}});const W=async()=>{await P()},T=D(()=>{if(!n.value||n.value.length===0)return console.log("No data available in reportData"),{title:{text:"No Data Available",left:"center",top:"center"}};const r=n.value.filter(a=>a.pv!==null&&a.pv!==void 0&&a.pv!==""&&!isNaN(a.pv));if(console.log("Filtered Data:",r),r.length===0)return{title:{text:"No Valid Data Available",left:"center",top:"center"}};const e=[...r].reverse(),t=[],s=[];return e.forEach(a=>{const d=new Date(a.timestamp),g=`${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;t.push(g),s.push(parseFloat(a.pv))}),console.log("Timestamps (oldest â†’ newest):",t),console.log("Pressure Values:",s),{tooltip:{trigger:"axis"},grid:{left:"10%",right:"5%",bottom:"15%",containLabel:!0},xAxis:{type:"category",boundaryGap:!1,data:t,axisLabel:{fontSize:window.innerWidth<768?10:12,rotate:30,interval:"auto"}},yAxis:{type:"value",name:"Pressure (bar)",min:function(a){return Math.floor(a.min*0)},max:function(a){return Math.ceil(a.max*1.1)},interval:.5,axisLabel:{formatter:a=>a.toFixed(2)+" bar",fontSize:window.innerWidth<768?10:12},splitLine:{show:!0,lineStyle:{type:"dashed",color:"#ddd"}}},series:[{name:"Pressure",type:"line",data:s,smooth:!0,lineStyle:{width:3,color:"#FFA500"},symbol:"circle",symbolSize:window.innerWidth<768?4:6,areaStyle:{color:"rgba(255, 165, 0, 0.2)"}}]}}),_=D(()=>n.value);D(()=>Math.ceil(n.value.length/I.value));const A=()=>{i=N.map("device-map",{center:[22.3511,78.6677],zoom:5,maxBounds:[[6.5,68],[35,97.5]],maxBoundsViscosity:1}),N.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(i),x()},R=p("Fetching..."),J=async(r,e)=>{try{const t=await S.get(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${r}&lon=${e}`);if(t.data&&t.data.display_name)return t.data.display_name}catch(t){console.error("Error fetching location name:",t)}return"Unknown Location"},x=async()=>{var j,B;if(!i){console.warn("Map is not initialized yet.");return}console.log("Updating Map..."),C.forEach(l=>i.removeLayer(l)),C=[];let r=n.value.filter(l=>l.lat&&l.long).sort((l,$)=>new Date($.timestamp)-new Date(l.timestamp))[0],e=n.value.filter(l=>l.pv!==null&&l.pv!==void 0&&l.bt!==null&&l.bt!==void 0).sort((l,$)=>new Date($.timestamp)-new Date(l.timestamp))[0];if(!r||!e){console.warn("No valid latitude/longitude or PV/BT found.");return}let t=Number(r.lat),s=Number(r.long),a=(j=e.pv)!=null?j:"N/A",d=(B=e.bt)!=null?B:"N/A",g=new Date(r.timestamp).toLocaleString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).replace(",","");R.value=await J(t,s);const c=N.icon({iconUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",shadowSize:[41,41]});let k=N.marker([t,s],{icon:c}).addTo(i);C.push(k);let X=`
<strong>Device ID:</strong> ${v.value} <br>
<strong>Serial Number:</strong> ${b.query.serialNumber||"N/A"} <br>
<strong>Pressure:</strong> ${a} bar<br>
<strong>Battery:</strong> ${d}% <br>
<strong>Timestamp:</strong> ${g} <br>

  `;k.bindPopup(X),k.on("mouseover",function(){this.openPopup()}),k.on("mouseout",function(){this.closePopup()}),console.log("Latest Marker Plotted at:",t,s,"Location:",R.value),i.setView([t,s],12)};E(_,x,{deep:!0});const O=()=>{i&&(i.remove(),i=null),A()};return E(n,()=>{O(),x(),T.value={...T.value}},{deep:!0}),M(async()=>{await P(),A(),x()}),(r,e)=>(f(),h("div",me,[o("div",ge,[o("button",{onClick:e[0]||(e[0]=t=>r.$router.push("/")),class:"ml-4"},e[3]||(e[3]=[o("img",{src:ue,alt:"Download",class:"w-10 h-10"},null,-1)])),o("h2",he," Sr.No: "+u(r.$route.query.serialNumber||"N/A")+" | ID: "+u(v.value),1),o("button",{onClick:q,class:"ml-4"},e[4]||(e[4]=[o("img",{src:z,alt:"Download",class:"w-10 h-10"},null,-1)]))]),o("div",fe,[o("div",be,[e[5]||(e[5]=o("label",{class:"font-semibold"},"From Date:",-1)),V(o("input",{type:"date","onUpdate:modelValue":e[1]||(e[1]=t=>y.value=t),class:"border rounded px-2 py-1"},null,512),[[U,y.value]])]),o("div",ve,[e[6]||(e[6]=o("label",{class:"font-semibold"},"To Date:",-1)),V(o("input",{type:"date","onUpdate:modelValue":e[2]||(e[2]=t=>w.value=t),class:"border rounded px-2 py-1"},null,512),[[U,w.value]])]),o("button",{onClick:W,class:"bg-[#08444c] text-white px-4 py-2 rounded"},"Generete Report")]),m.value?(f(),h("div",ye,e[7]||(e[7]=[o("svg",{class:"animate-spin h-10 w-10 text-blue-500",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"4"},[o("circle",{cx:"12",cy:"12",r:"10","stroke-opacity":"0.2"}),o("path",{d:"M22 12a10 10 0 1 1-10-10","stroke-linecap":"round"})],-1)]))):L("",!0),!m.value&&_.value.length>0?(f(),h("div",we,[o("div",_e,[o("table",xe,[e[8]||(e[8]=o("thead",{class:"bg-gray-200"},[o("tr",null,[o("th",{class:"border border-gray-300 px-4 py-2"},"Timestamp"),o("th",{class:"border border-gray-300 px-4 py-2"},"Pressure (bar)"),o("th",{class:"border border-gray-300 px-4 py-2"},"Battery (%)"),o("th",{class:"border border-gray-300 px-4 py-2"},"Sensor Health"),o("th",{class:"border border-gray-300 px-4 py-2"},"Signal Strength")])],-1)),o("tbody",null,[(f(!0),h(K,null,Q(_.value,t=>(f(),h("tr",{key:t.timestamp,class:"text-center"},[o("td",ke,u(t.timestamp.slice(0,16)),1),o("td",De,u(t.pv),1),o("td",Se,u(t.bt),1),o("td",Ne,u(t.ht),1),o("td",Ce,u(t.rssi),1)]))),128))])])])])):L("",!0),!m.value&&_.value.length===0?(f(),h("p",Te," No data available for this device. ")):L("",!0),o("div",$e,[o("div",Le,[o("h3",Fe,[e[9]||(e[9]=Y(" Pressure Graph - ")),o("span",Pe,u(r.$route.query.serialNumber||"N/A"),1)]),o("button",{onClick:G,class:"ml-auto w-8 h-8 md:w-10 md:h-10"},e[10]||(e[10]=[o("img",{src:z,alt:"Download",class:"w-full h-full"},null,-1)]))]),Z(ee(re),{id:"pressureChart",class:"w-full h-80",option:T.value},null,8,["option"])]),e[11]||(e[11]=o("div",{class:"h-6"},null,-1))]))}},ht=se(Ae,[["__scopeId","data-v-a308d981"]]);export{ht as default};
